name: Admin Backend CI/CD Deployment

on:
  repository_dispatch:
    types: [admin-backend-deploy]
  workflow_dispatch:

jobs:
  deploy-admin-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Admin Repository
        uses: actions/checkout@v4
        with:
          repository: dibyajyoti-chakrabarti/ReportMitra_Admin
          ref: main
          path: ReportMitra_Admin

      - name: Deploy admin backend via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ADMIN_EC2_HOST }}
          username: ${{ secrets.ADMIN_EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/Reportmitra_Admin/backend
            git pull origin main
            source venv/bin/activate
            sudo systemctl restart reportmitra-admin
            sudo systemctl reload nginx
            sudo systemctl status reportmitra-admin --no-pager