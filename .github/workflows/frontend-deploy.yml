name: Frontend CI/CD Deployment

on:
  repository_dispatch:
    types: [frontend-deploy]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-frontend:
    name: Build & Deploy Frontend to S3 + CloudFront
    runs-on: ubuntu-latest

    env:
      VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
      VITE_BACKEND_URL: ${{ secrets.VITE_BACKEND_URL }}
      VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

    steps:
      - name: Checkout frontend repository
        uses: actions/checkout@v4
        with:
          repository: dibyajyoti-chakrabarti/ReportMitra_FullStack
          ref: main
          path: ReportMitra_FullStack

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.21.1
          cache: npm
          cache-dependency-path: ReportMitra_FullStack/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ReportMitra_FullStack/frontend
        run: npm ci

      - name: Build frontend
        working-directory: ReportMitra_FullStack/frontend
        run: |
          echo "VITE_API_BASE_URL=$VITE_API_BASE_URL" > .env.production
          echo "VITE_BACKEND_URL=$VITE_BACKEND_URL" >> .env.production
          echo "VITE_GOOGLE_CLIENT_ID=$VITE_GOOGLE_CLIENT_ID" >> .env.production
          npm run build -- --mode production

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::855386719823:role/github-frontend-deploy-role
          aws-region: ap-south-1

      - name: Deploy to S3
        run: |
          aws s3 sync ReportMitra_FullStack/frontend/dist \
            s3://www.reportmitra.in \
            --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id E3K3I6ZXEVAINS \
            --paths "/*"
